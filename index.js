require("dotenv").config();
const TelegramBot = require("node-telegram-bot-api");
const fs = require("fs");

const bot = new TelegramBot(process.env.TELEGRAM_TOKEN, { polling: true });

let users = {};

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–∞–∑–∏
if (fs.existsSync("./users.json")) {
  users = JSON.parse(fs.readFileSync("./users.json", "utf8"));
}

// –ö–æ–Ω—Ç–µ–Ω—Ç —á–µ–ª–µ–Ω–¥–∂—É (7 –¥–Ω—ñ–≤)
const workouts = [
  // –î–µ–Ω—å 1
  "üóìÔ∏è *–î–µ–Ω—å 1: –ü—Ä–æ—Å—Ç–æ –∑‚Äô—è–≤–∏—Å—å*\n\n" +
    "–†–æ–∑–º–∏–Ω–∫–∞:\n‚ñ´Ô∏è 30 —Å–µ–∫ –±—ñ–≥ –Ω–∞ –º—ñ—Å—Ü—ñ\n‚ñ´Ô∏è 20 —Å—Ç—Ä–∏–±–∫—ñ–≤ –∑ –ø—ñ–¥–π–æ–º–æ–º –∫–æ–ª—ñ–Ω\n\n" +
    "–û—Å–Ω–æ–≤–Ω–µ:\n" +
    "1. 15 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å\n" +
    "2. 10 –≤—ñ–¥–∂–∏–º–∞–Ω—å\n" +
    "3. 20 —Å–µ–∫ –ø–ª–∞–Ω–∫–∏\n" +
    "4. 15 –ø—ñ–¥–π–æ–º—ñ–≤ –∫–æ–ª—ñ–Ω —Å—Ç–æ—è—á–∏\n" +
    "5. 30 —Å–µ–∫ —Å—Ç—Ä–∏–±–∫—ñ–≤ –Ω–∞ –º—ñ—Å—Ü—ñ\n\n" +
    "_–î—É–º–∫–∞: –¢–∏ –Ω–µ –º—É—Å–∏—à –±—É—Ç–∏ —ñ–¥–µ–∞–ª—å–Ω–∏–º. –ê–ª–µ –º—É—Å–∏—à –∑‚Äô—è–≤–∏—Ç–∏—Å—å._",

  // –î–µ–Ω—å 2
  "üóìÔ∏è *–î–µ–Ω—å 2: –°—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å*\n\n" +
    "1. 10 –≤–∏–ø–∞–¥—ñ–≤ –Ω–∞ –∫–æ–∂–Ω—É –Ω–æ–≥—É\n" +
    "2. 10 –≤—ñ–¥–∂–∏–º–∞–Ω—å –∑ –ø–∞—É–∑–æ—é\n" +
    "3. 30 —Å–µ–∫ –±–æ–∫–æ–≤–æ—ó –ø–ª–∞–Ω–∫–∏ (–ø–æ 15 —Å–µ–∫ –Ω–∞ –±—ñ–∫)\n" +
    "4. 20 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å —Å—É–º–æ\n" +
    "5. 30 —Å–µ–∫ ¬´—Å—Ç—ñ–ª–µ—Ü—å¬ª –±—ñ–ª—è —Å—Ç—ñ–Ω–∏\n\n" +
    "_–î—É–º–∫–∞: –ü—Ä–æ—Å—Ç—ñ –¥—ñ—ó ‚Äî —Å–∏–ª—å–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏._",

  // –î–µ–Ω—å 3
  "üóìÔ∏è *–î–µ–Ω—å 3: –†–∏—Ç–º*\n\n" +
    "1. 15 –±–µ—Ä–ø—ñ (–ø–æ–≤—ñ–ª—å–Ω–æ)\n" +
    "2. 20 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å\n" +
    "3. 10 –∑—ñ—Ä–∫–æ–≤–∏—Ö —Å—Ç—Ä–∏–±–∫—ñ–≤\n" +
    "4. 30 —Å–µ–∫ –±—ñ–≥—É –Ω–∞ –º—ñ—Å—Ü—ñ\n" +
    "5. 15 –≤–∏–ø–∞–¥—ñ–≤ —É –±—ñ–∫\n\n" +
    "_–î—É–º–∫–∞: –î–∏—Ö–∞–π. –†—É—Ö–∞–π—Å—è. –ü–æ–≤–µ—Ä—Ç–∞–π—Å—è –¥–æ —Å–µ–±–µ._",

  // –î–µ–Ω—å 4
  "üóìÔ∏è *–î–µ–Ω—å 4: –°–∏–ª–∞*\n\n" +
    "1. 20 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å —ñ–∑ –∑—É–ø–∏–Ω–∫–æ—é –≤–Ω–∏–∑—É\n" +
    "2. 15 –≤—ñ–¥–∂–∏–º–∞–Ω—å\n" +
    "3. 45 —Å–µ–∫ –ø–ª–∞–Ω–∫–∏\n" +
    "4. 20 —Å–∫—Ä—É—á—É–≤–∞–Ω—å –Ω–∞ –ø—Ä–µ—Å\n" +
    "5. 30 —Å–µ–∫ ¬´–ª–æ–¥–æ—á–∫–∞¬ª –Ω–∞ —Å–ø–∏–Ω—ñ\n\n" +
    "_–î—É–º–∫–∞: –ú—ñ—Ü–Ω—ñ—Å—Ç—å ‚Äî —Ü–µ –∑–≤–∏—á–∫–∞._",

  // –î–µ–Ω—å 5
  "üóìÔ∏è *–î–µ–Ω—å 5: –®–≤–∏–¥–∫—ñ—Å—Ç—å —ñ —Ñ–æ–∫—É—Å*\n\n" +
    "1. –¢–∞–±–∞—Ç–∞: 20 —Å–µ–∫ –ø—Ä–∏—Å—ñ–¥–∞–Ω–Ω—è ‚Äî 10 —Å–µ–∫ –ø–∞—É–∑–∞\n" +
    "2. –¢–∞–±–∞—Ç–∞: 20 —Å–µ–∫ –±–µ—Ä–ø—ñ ‚Äî 10 —Å–µ–∫ –ø–∞—É–∑–∞\n" +
    "3. –¢–∞–±–∞—Ç–∞: 20 —Å–µ–∫ –≤—ñ–¥–∂–∏–º–∞–Ω–Ω—è ‚Äî 10 —Å–µ–∫ –ø–∞—É–∑–∞\n" +
    "4. –¢–∞–±–∞—Ç–∞: 20 —Å–µ–∫ —Å–∫—Ä—É—á—É–≤–∞–Ω–Ω—è ‚Äî 10 —Å–µ–∫ –ø–∞—É–∑–∞\n" +
    "5. –ü–ª–∞–Ω–∫–∞ 30 —Å–µ–∫\n\n" +
    "_–î—É–º–∫–∞: –ó–±–µ—Ä–∏ —Å–µ–±–µ –¥–æ–∫—É–ø–∏._",

  // –î–µ–Ω—å 6
  "üóìÔ∏è *–î–µ–Ω—å 6: –ü–∞—É–∑–∞ –∑ —Ä—É—Ö–æ–º*\n\n" +
    "1. 30 —Å–µ–∫ –¥–∏—Ö–∞–ª—å–Ω–∞ –≤–ø—Ä–∞–≤–∞ (–≥–ª–∏–±–æ–∫—ñ –≤–¥–∏—Ö–∏/–≤–∏–¥–∏—Ö–∏)\n" +
    "2. –†–æ–∑—Ç—è–∂–∫–∞ —à–∏—ó ‚Äî 30 —Å–µ–∫\n" +
    "3. –ù–∞—Ö–∏–ª–∏ –≤–ø–µ—Ä–µ–¥ ‚Äî 20 —Å–µ–∫\n" +
    "4. –†–æ–∑—Ç—è–∂–∫–∞ –∫–≤–∞–¥—Ä–∏—Ü–µ–ø—Å—ñ–≤ —Å—Ç–æ—è—á–∏ ‚Äî 20 —Å–µ–∫ –Ω–∞ –Ω–æ–≥—É\n" +
    "5. –í–ø—Ä–∞–≤–∞ ¬´–∫—ñ—à–∫–∞-–∫–æ—Ä–æ–≤–∞¬ª ‚Äî 10 —Ä–∞–∑—ñ–≤\n\n" +
    "_–î—É–º–∫–∞: –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è ‚Äî —Ü–µ —Ç–µ–∂ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è._",

  // –î–µ–Ω—å 7
  "üóìÔ∏è *–î–µ–Ω—å 7: –¢–∏ –≤ –≥—Ä—ñ!*\n\n" +
    "1. 15 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å\n" +
    "2. 10 –≤—ñ–¥–∂–∏–º–∞–Ω—å\n" +
    "3. 30 —Å–µ–∫ –ø–ª–∞–Ω–∫–∞\n" +
    "4. 15 –±–µ—Ä–ø—ñ\n" +
    "5. 30 —Å–µ–∫ ¬´—Å—Ç—ñ–ª–µ—Ü—å¬ª –±—ñ–ª—è —Å—Ç—ñ–Ω–∏\n\n" +
    "_–¢–∏ –∑—Ä–æ–±–∏–≤ —Ü–µ! –ì–æ—Ç–æ–≤–∏–π –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?\nüëâ [–ü—Ä–∏–¥–±–∞—Ç–∏ 30-–¥–µ–Ω–Ω–∏–π –ø–ª–∞–Ω](https://your-stripe-link.com)_",
];

// –ó–±–µ—Ä–µ–≥—Ç–∏ –ë–î
function saveUsers() {
  fs.writeFileSync("./users.json", JSON.stringify(users));
}

// –ó–±–µ—Ä–µ–≥—Ç–∏ –ë–î
function saveUsers() {
  fs.writeFileSync("./users.json", JSON.stringify(users));
}

// –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –º–∏–Ω—É–≤ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –¥–µ–Ω—å
function isNextDayAvailable(user) {
  if (!user.lastCompletedAt) return true;

  const last = new Date(user.lastCompletedAt);
  const now = new Date();

  return (
    now.getUTCFullYear() > last.getUTCFullYear() ||
    now.getUTCMonth() > last.getUTCMonth() ||
    now.getUTCDate() > last.getUTCDate()
  );
}

// /start
bot.onText(/\/start/, (msg) => {
  const id = msg.chat.id;

  if (!users[id]) {
    users[id] = { day: 0, lastCompletedAt: null };
    saveUsers();
  }

  bot.sendMessage(
    id,
    `–ü—Ä–∏–≤—ñ—Ç, ${msg.from.first_name}! üëã\n\n–†–æ–∑–ø–æ—á–Ω–µ–º–æ 7-–¥–µ–Ω–Ω–∏–π —Ñ—ñ—Ç–Ω–µ—Å-—á–µ–ª–µ–Ω–¥–∂?\n–ö–æ–∂–Ω–æ–≥–æ –¥–Ω—è ‚Äî –Ω–æ–≤–µ –∫–æ—Ä–æ—Ç–∫–µ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è üí™`,
    {
      reply_markup: {
        keyboard: [["–ü–æ—á–∞—Ç–∏"]],
        resize_keyboard: true,
      },
    }
  );
});

// –Ω–∞—Ç–∏—Å–Ω—É–≤ ‚Äú–ü–æ—á–∞—Ç–∏‚Äù
bot.onText(/–ü–æ—á–∞—Ç–∏/, (msg) => {
  const id = msg.chat.id;
  const user = users[id];
  if (!user) return;

  if (!isNextDayAvailable(user) && user.day > 0 && user.day < workouts.length) {
    bot.sendMessage(
      id,
      "‚è≥ –ù–∞—Å—Ç—É–ø–Ω–µ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –±—É–¥–µ –¥–æ—Å—Ç—É–ø–Ω–µ –∑–∞–≤—Ç—Ä–∞. –ü–æ–≤–µ—Ä—Ç–∞–π—Å—è –ø—ñ–∑–Ω—ñ—à–µ üí™"
    );
  } else {
    sendWorkout(id);
  }
});

// –Ω–∞—Ç–∏—Å–Ω—É–≤ ‚Äú–ó—Ä–æ–±–ª–µ–Ω–æ ‚úÖ‚Äù
bot.onText(/–ó—Ä–æ–±–ª–µ–Ω–æ ‚úÖ/, (msg) => {
  const id = msg.chat.id;
  const user = users[id];
  if (!user) return;

  user.lastCompletedAt = new Date().toISOString();
  user.day += 1;
  saveUsers();

  if (user.day >= workouts.length) {
    bot.sendMessage(
      id,
      "üéâ –¢–∏ –∑–∞–≤–µ—Ä—à–∏–≤ —á–µ–ª–µ–Ω–¥–∂! üî•\n\nüëâ –•–æ—á–µ—à –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?\n[–ü—Ä–∏–¥–±–∞—Ç–∏ 30-–¥–µ–Ω–Ω–∏–π –ø–ª–∞–Ω](https://your-stripe-link.com)",
      {
        parse_mode: "Markdown",
        disable_web_page_preview: true,
      }
    );
  } else {
    bot.sendMessage(id, "–ì–æ—Ç–æ–≤–æ! –ù–∞—Å—Ç—É–ø–Ω–µ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –≤—ñ–¥–∫—Ä–∏—î—Ç—å—Å—è –∑–∞–≤—Ç—Ä–∞ üí•");
  }
});

// –≤—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤–ø—Ä–∞–≤–∏
function sendWorkout(id) {
  const user = users[id];
  const day = user.day;

  const text = workouts[day] || "–¢–∏ –∑–∞–≤–µ—Ä—à–∏–≤ –≤—Å—ñ –¥–Ω—ñ!";
  bot.sendMessage(id, text, {
    parse_mode: "Markdown",
    reply_markup: {
      keyboard: [["–ó—Ä–æ–±–ª–µ–Ω–æ ‚úÖ"]],
      resize_keyboard: true,
    },
  });
}

console.log("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–æ —á–µ—Ä–µ–∑ long polling...");
